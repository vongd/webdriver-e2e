import fs from 'node:fs/promises';
import url from 'node:url';
import path from 'node:path';
import logger from '@wdio/logger';
import getPort from 'get-port';
import fastify from 'fastify';
import fastifyCors from '@fastify/cors';
import fastifyStatic from '@fastify/static';
import { request } from 'undici';
import getWorkbench from './workbench.tpl.js';
import { getWorkbenchOptions } from './utils.js';
import { getFileType } from '../utils.js';
import { fsProviderExtensionPrefix } from './constants.js';
import { DEFAULT_VSCODE_WEB_PORT, DEFAULT_CHANNEL, DEFAULT_VSCODE_WEB_HOSTNAME } from '../constants.js';
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
const log = logger('wdio-vscode-service/server');
const mountPrefix = '/static/mount';
const webviewHostRegexp = /^https:\/\/[^.]+\.vscode-webview\.net$/;
/**
 * ToDo(Christian): missing capabilities:
 *   - allow serve VSCode sources from path location or CDN
 *   - allow to include additional extensions (#20)
 */
export default async function startServer(standalone, options) {
    const app = fastify({ logger: true });
    const port = await getPort({ port: options.serverOptions?.port || DEFAULT_VSCODE_WEB_PORT });
    await app.register(fastifyCors, {
        methods: ['GET'],
        credentials: true,
        origin: (origin, cb) => cb(null, webviewHostRegexp.test(origin))
    });
    app.addHook('preHandler', async (req, reply) => {
        // eslint-disable-next-line @typescript-eslint/no-floating-promises
        reply.header('Access-Control-Allow-Origin', '*');
        const value = req.query['vscode-coi'];
        if (value === '1') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Opener-Policy', 'same-origin');
        }
        else if (value === '2') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Embedder-Policy', 'require-corp');
        }
        else if (value === '3' || value === '') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Opener-Policy', 'same-origin');
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Embedder-Policy', 'require-corp');
        }
    });
    if (options.extensionPath) {
        log.info(`Serving dev extensions from ${options.extensionPath}`);
        await app.register(fastifyStatic, {
            prefix: '/static/devextensions',
            root: options.extensionPath
        });
    }
    await app.register(fastifyStatic, {
        prefix: '/static/build',
        root: standalone.path,
        decorateReply: false // the reply decorator has been added by the first plugin registration
    });
    if (options.workspacePath) {
        log.info(`Serve workspace from ${options.workspacePath}`);
        app.addHook('preHandler', async (req, reply) => {
            const filePath = req.params['*'];
            const queries = Object.keys(req.query);
            if (!options.workspacePath || !filePath || !req.url.startsWith(mountPrefix)) {
                return null;
            }
            const p = path.join(options.workspacePath, filePath === mountPrefix.slice(1)
                ? filePath.slice(mountPrefix.length - 1)
                : filePath);
            if (queries.includes('stat')) {
                try {
                    const stats = await fs.stat(p);
                    // eslint-disable-next-line @typescript-eslint/return-await
                    return reply.send(JSON.stringify({
                        type: getFileType(stats),
                        ctime: stats.ctime.getTime(),
                        mtime: stats.mtime.getTime(),
                        size: stats.size
                    }));
                }
                catch (e) {
                    log.warn(e.stack);
                    return reply.send(JSON.stringify({
                        error: e.code
                    }));
                }
            }
            if (queries.includes('readdir')) {
                try {
                    const entries = await fs.readdir(p, { withFileTypes: true });
                    // eslint-disable-next-line @typescript-eslint/return-await
                    return reply.send(JSON.stringify(entries.map((d) => ({ name: d.name, type: getFileType(d) }))));
                }
                catch (e) {
                    log.warn(e.stack);
                    return reply.send(JSON.stringify({
                        error: e.code
                    }));
                }
            }
            return null;
        });
        await app.register(fastifyStatic, {
            prefix: `${mountPrefix}/`,
            root: options.workspacePath,
            dotfiles: 'allow',
            decorateReply: false // the reply decorator has been added by the first plugin registration
        });
        await app.register(fastifyStatic, {
            prefix: fsProviderExtensionPrefix,
            root: path.join(__dirname, '..', '..', 'src', 'server', 'fs-provider'),
            decorateReply: false // the reply decorator has been added by the first plugin registration
        });
    }
    /**
     * mount additional extensions here, e.g.:
     * ```
     * if (config.extensionPaths) {
     *   config.extensionPaths.forEach((extensionPath, index) => {
     *     console.log('Serving additional built-in extensions from ' + extensionPath);
     *     app.use(kmount(`/static/extensions/${index}`, kstatic(extensionPath, serveOptions)));
     *   });
     * }
     * ```
     * when working on https://github.com/webdriverio-community/wdio-vscode-service/issues/20
     */
    /**
     * Workbench
     */
    app.get('/callback', async (req, reply) => {
        const host = `${req.protocol}://${req.hostname || DEFAULT_VSCODE_WEB_HOSTNAME}:${port}`;
        const cbUrl = `${host}/${req.url}/out/vs/code/browser/workbench/callback.html`;
        const { body } = await request(cbUrl, {});
        await reply.send(body);
    });
    app.get('/', async (req, reply) => {
        const hostname = req.hostname || DEFAULT_VSCODE_WEB_HOSTNAME;
        const host = `${req.protocol}://${hostname}`;
        const webConfiguration = await getWorkbenchOptions({ protocol: req.protocol, host: hostname }, {
            /**
             * modify when support additional extension
             */
            extensionPaths: [],
            extensionIds: [],
            extensionDevelopmentPath: options.extensionPath,
            build: {
                type: 'static',
                location: standalone.path,
                quality: (options.version || DEFAULT_CHANNEL),
                version: standalone.version
            },
            extensionTestsPath: undefined,
            folderUri: undefined,
            folderMountPath: options.workspacePath,
            printServerLog: true
        });
        const template = getWorkbench({
            baseUrl: `${host}/static/build`,
            webConfiguration: JSON.stringify(webConfiguration).replace(/"/g, '&quot;'),
            authSession: '',
            builtinExtensions: '[]'
        });
        // eslint-disable-next-line @typescript-eslint/no-floating-promises
        reply.header('Content-Type', 'text/html');
        return reply.send(template);
    });
    await app.listen(port);
    log.info(`VSCode server started on port ${port}`);
    return port;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFFNUIsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLE9BQTJCLE1BQU0sU0FBUyxDQUFBO0FBQ2pELE9BQU8sV0FBVyxNQUFNLGVBQWUsQ0FBQTtBQUN2QyxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBRWhDLE9BQU8sWUFBWSxNQUFNLG9CQUFvQixDQUFBO0FBQzdDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQ3pDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQzFELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxlQUFlLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUd2RyxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDbEUsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLDRCQUE0QixDQUFDLENBQUE7QUFFaEQsTUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFBO0FBQ25DLE1BQU0saUJBQWlCLEdBQUcsd0NBQXdDLENBQUE7QUFRbEU7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFV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UztZQUNwQixlQUFlLEVBQUUsT0FBTyxDQUFDLGFBQWE7WUFDdEMsY0FBYyxFQUFFLElBQUk7U0FDdkIsQ0FDSixDQUFBO1FBRUQsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxHQUFHLElBQUksZUFBZTtZQUMvQixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUM7WUFDMUUsV0FBVyxFQUFFLEVBQUU7WUFDZixpQkFBaUIsRUFBRSxJQUFJO1NBQzFCLENBQUMsQ0FBQTtRQUVGLG1FQUFtRTtRQUNuRSxLQUFLLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxXQUFXLENBQUMsQ0FBQTtRQUN6QyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDL0IsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDdEIsR0FBRyxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUNqRCxPQUFPLElBQUksQ0FBQTtBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnbm9kZTpmcy9wcm9taXNlcydcbmltcG9ydCB1cmwgZnJvbSAnbm9kZTp1cmwnXG5pbXBvcnQgcGF0aCBmcm9tICdub2RlOnBhdGgnXG5cbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IGdldFBvcnQgZnJvbSAnZ2V0LXBvcnQnXG5pbXBvcnQgZmFzdGlmeSwgeyBGYXN0aWZ5UmVxdWVzdCB9IGZyb20gJ2Zhc3RpZnknXG5pbXBvcnQgZmFzdGlmeUNvcnMgZnJvbSAnQGZhc3RpZnkvY29ycydcbmltcG9ydCBmYXN0aWZ5U3RhdGljIGZyb20gJ0BmYXN0aWZ5L3N0YXRpYydcbmltcG9ydCB7IHJlcXVlc3QgfSBmcm9tICd1bmRpY2knXG5cbmltcG9ydCBnZXRXb3JrYmVuY2ggZnJvbSAnLi93b3JrYmVuY2gudHBsLmpzJ1xuaW1wb3J0IHsgZ2V0V29ya2JlbmNoT3B0aW9ucyB9IGZyb20gJy4vdXRpbHMuanMnXG5pbXBvcnQgeyBnZXRGaWxlVHlwZSB9IGZyb20gJy4uL3V0aWxzLmpzJ1xuaW1wb3J0IHsgZnNQcm92aWRlckV4dGVuc2lvblByZWZpeCB9IGZyb20gJy4vY29uc3RhbnRzLmpzJ1xuaW1wb3J0IHsgREVGQVVMVF9WU0NPREVfV0VCX1BPUlQsIERFRkFVTFRfQ0hBTk5FTCwgREVGQVVMVF9WU0NPREVfV0VCX0hPU1ROQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzLmpzJ1xuaW1wb3J0IHR5cGUgeyBWU0NvZGVPcHRpb25zLCBCdW5kbGUgfSBmcm9tICcuLi90eXBlcydcblxuY29uc3QgX19kaXJuYW1lID0gdXJsLmZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLicsIGltcG9ydC5tZXRhLnVybCkpXG5jb25zdCBsb2cgPSBsb2dnZXIoJ3dkaW8tdnNjb2RlLXNlcnZpY2Uvc2VydmVyJylcblxuY29uc3QgbW91bnRQcmVmaXggPSAnL3N0YXRpYy9tb3VudCdcbmNvbnN0IHdlYnZpZXdIb3N0UmVnZXhwID0gL15odHRwczpcXC9cXC9bXi5dK1xcLnZzY29kZS13ZWJ2aWV3XFwubmV0JC9cblxudHlwZSBDT0lSZXF1ZXN0ID0gRmFzdGlmeVJlcXVlc3Q8e1xuICAgIFF1ZXJ5c3RyaW5nOiB7XG4gICAgICAgICd2c2NvZGUtY29pJzogJzEnIHwgJzInIHwgJzMnXG4gICAgfVxufT5cblxuLyoqXG4gKiBUb0RvKENocmlzdGlhbik6IG1pc3NpbmcgY2FwYWJpbGl0aWVzOlxuICogICAtIGFsbG93IHNlcnZlIFZTQ29kZSBzb3VyY2VzIGZyb20gcGF0aCBsb2NhdGlvbiBvciBDRE5cbiAqICAgLSBhbGxvdyB0byBpbmNsdWRlIGFkZGl0aW9uYWwgZXh0ZW5zaW9ucyAoIzIwKVxuICovXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBzdGFydFNlcnZlciAoc3RhbmRhbG9uZTogQnVuZGxlLCBvcHRpb25zOiBWU0NvZGVPcHRpb25zKSB7XG4gICAgY29uc3QgYXBwID0gZmFzdGlmeSh7IGxvZ2dlcjogdHJ1ZSB9KVxuICAgIGNvbnN0IHBvcnQgPSBhd2FpdCBnZXRQb3J0KHsgcG9ydDogb3B0aW9ucy5zZXJ2ZXJPcHRpb25zPy5wb3J0IHx8IERFRkFVTFRfVlNDT0RFX1dFQl9QT1JUIH0pXG4gICAgYXdhaXQgYXBwLnJlZ2lzdGVyKGZhc3RpZnlDb3JzLCB7XG4gICAgICAgIG1ldGhvZHM6IFsnR0VUJ10sXG4gICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgICBvcmlnaW46IChvcmlnaW4sIGNiKSA9PiBjYihudWxsLCB3ZWJ2aWV3SG9zdFJlZ2V4cC50ZXN0KG9yaWdpbikpXG4gICAgfSlcblxuICAgIGFwcC5hZGRIb29rKCdwcmVIYW5kbGVyJywgYXN5bmMgKHJlcTogQ09JUmVxdWVzdCwgcmVwbHkpID0+IHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICByZXBseS5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJylcblxuICAgICAgICBjb25zdCB2YWx1ZSA9IHJlcS5xdWVyeVsndnNjb2RlLWNvaSddXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gJzEnKSB7XG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgICAgICByZXBseS5oZWFkZXIoJ0Nyb3NzLU9yaWdpbi1PcGVuZXItUG9saWN5JywgJ3NhbWUtb3JpZ2luJylcbiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJzInKSB7XG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgICAgICByZXBseS5oZWFkZXIoJ0Nyb3NzLU9yaWdpbi1FbWJlZGRlci1Qb2xpY3knLCAncmVxdWlyZS1jb3JwJylcbiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJzMnIHx8IHZhbHVlID09PSAnJykge1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICAgICAgcmVwbHkuaGVhZGVyKCdDcm9zcy1PcmlnaW4tT3BlbmVyLVBvbGljeScsICdzYW1lLW9yaWdpbicpXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgICAgICByZXBseS5oZWFkZXIoJ0Nyb3NzLU9yaWdpbi1FbWJlZGRlci1Qb2xpY3knLCAncmVxdWlyZS1jb3JwJylcbiAgICAgICAgfVxuICAgIH0pXG5cbiAgICBpZiAob3B0aW9ucy5leHRlbnNpb25QYXRoKSB7XG4gICAgICAgIGxvZy5pbmZvKGBTZXJ2aW5nIGRldiBleHRlbnNpb25zIGZyb20gJHtvcHRpb25zLmV4dGVuc2lvblBhdGh9YClcbiAgICAgICAgYXdhaXQgYXBwLnJlZ2lzdGVyKGZhc3RpZnlTdGF0aWMsIHtcbiAgICAgICAgICAgIHByZWZpeDogJy9zdGF0aWMvZGV2ZXh0ZW5zaW9ucycsXG4gICAgICAgICAgICByb290OiBvcHRpb25zLmV4dGVuc2lvblBhdGhcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBhd2FpdCBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgICAgICBwcmVmaXg6ICcvc3RhdGljL2J1aWxkJyxcbiAgICAgICAgcm9vdDogc3RhbmRhbG9uZS5wYXRoLFxuICAgICAgICBkZWNvcmF0ZVJlcGx5OiBmYWxzZSAvLyB0aGUgcmVwbHkgZGVjb3JhdG9yIGhhcyBiZWVuIGFkZGVkIGJ5IHRoZSBmaXJzdCBwbHVnaW4gcmVnaXN0cmF0aW9uXG4gICAgfSlcblxuICAgIGlmIChvcHRpb25zLndvcmtzcGFjZVBhdGgpIHtcbiAgICAgICAgbG9nLmluZm8oYFNlcnZlIHdvcmtzcGFjZSBmcm9tICR7b3B0aW9ucy53b3Jrc3BhY2VQYXRofWApXG4gICAgICAgIGFwcC5hZGRIb29rKCdwcmVIYW5kbGVyJywgYXN5bmMgKHJlcSwgcmVwbHkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gKHJlcS5wYXJhbXMgYXMgeyAnKic6IHN0cmluZyB9KVsnKiddXG4gICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gT2JqZWN0LmtleXMocmVxLnF1ZXJ5IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4pXG5cbiAgICAgICAgICAgIGlmICghb3B0aW9ucy53b3Jrc3BhY2VQYXRoIHx8ICFmaWxlUGF0aCB8fCAhcmVxLnVybC5zdGFydHNXaXRoKG1vdW50UHJlZml4KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHAgPSBwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgb3B0aW9ucy53b3Jrc3BhY2VQYXRoLFxuICAgICAgICAgICAgICAgIGZpbGVQYXRoID09PSBtb3VudFByZWZpeC5zbGljZSgxKVxuICAgICAgICAgICAgICAgICAgICA/IGZpbGVQYXRoLnNsaWNlKG1vdW50UHJlZml4Lmxlbmd0aCAtIDEpXG4gICAgICAgICAgICAgICAgICAgIDogZmlsZVBhdGhcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmIChxdWVyaWVzLmluY2x1ZGVzKCdzdGF0JykpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzLnN0YXQocClcbiAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9yZXR1cm4tYXdhaXRcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcGx5LnNlbmQoSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogZ2V0RmlsZVR5cGUoc3RhdHMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3RpbWU6IHN0YXRzLmN0aW1lLmdldFRpbWUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG10aW1lOiBzdGF0cy5tdGltZS5nZXRUaW1lKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzdGF0cy5zaXplXG4gICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICBsb2cud2FybihlLnN0YWNrKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVwbHkuc2VuZChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogKGUgYXMgTm9kZUpTLkVycm5vRXhjZXB0aW9uKS5jb2RlXG4gICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHF1ZXJpZXMuaW5jbHVkZXMoJ3JlYWRkaXInKSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVudHJpZXMgPSBhd2FpdCBmcy5yZWFkZGlyKHAsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KVxuICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3JldHVybi1hd2FpdFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVwbHkuc2VuZChKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMubWFwKChkKSA9PiAoeyBuYW1lOiBkLm5hbWUsIHR5cGU6IGdldEZpbGVUeXBlKGQpIH0pKVxuICAgICAgICAgICAgICAgICAgICApKVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICBsb2cud2FybihlLnN0YWNrKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVwbHkuc2VuZChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogKGUgYXMgTm9kZUpTLkVycm5vRXhjZXB0aW9uKS5jb2RlXG4gICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfSlcblxuICAgICAgICBhd2FpdCBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgICAgICAgICAgcHJlZml4OiBgJHttb3VudFByZWZpeH0vYCxcbiAgICAgICAgICAgIHJvb3Q6IG9wdGlvbnMud29ya3NwYWNlUGF0aCxcbiAgICAgICAgICAgIGRvdGZpbGVzOiAnYWxsb3cnLFxuICAgICAgICAgICAgZGVjb3JhdGVSZXBseTogZmFsc2UgLy8gdGhlIHJlcGx5IGRlY29yYXRvciBoYXMgYmVlbiBhZGRlZCBieSB0aGUgZmlyc3QgcGx1Z2luIHJlZ2lzdHJhdGlvblxuICAgICAgICB9KVxuICAgICAgICBhd2FpdCBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgICAgICAgICAgcHJlZml4OiBmc1Byb3ZpZGVyRXh0ZW5zaW9uUHJlZml4LFxuICAgICAgICAgICAgcm9vdDogcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3NyYycsICdzZXJ2ZXInLCAnZnMtcHJvdmlkZXInKSxcbiAgICAgICAgICAgIGRlY29yYXRlUmVwbHk6IGZhbHNlIC8vIHRoZSByZXBseSBkZWNvcmF0b3IgaGFzIGJlZW4gYWRkZWQgYnkgdGhlIGZpcnN0IHBsdWdpbiByZWdpc3RyYXRpb25cbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBtb3VudCBhZGRpdGlvbmFsIGV4dGVuc2lvbnMgaGVyZSwgZS5nLjpcbiAgICAgKiBgYGBcbiAgICAgKiBpZiAoY29uZmlnLmV4dGVuc2lvblBhdGhzKSB7XG4gICAgICogICBjb25maWcuZXh0ZW5zaW9uUGF0aHMuZm9yRWFjaCgoZXh0ZW5zaW9uUGF0aCwgaW5kZXgpID0+IHtcbiAgICAgKiAgICAgY29uc29sZS5sb2coJ1NlcnZpbmcgYWRkaXRpb25hbCBidWlsdC1pbiBleHRlbnNpb25zIGZyb20gJyArIGV4dGVuc2lvblBhdGgpO1xuICAgICAqICAgICBhcHAudXNlKGttb3VudChgL3N0YXRpYy9leHRlbnNpb25zLyR7aW5kZXh9YCwga3N0YXRpYyhleHRlbnNpb25QYXRoLCBzZXJ2ZU9wdGlvbnMpKSk7XG4gICAgICogICB9KTtcbiAgICAgKiB9XG4gICAgICogYGBgXG4gICAgICogd2hlbiB3b3JraW5nIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJkcml2ZXJpby1jb21tdW5pdHkvd2Rpby12c2NvZGUtc2VydmljZS9pc3N1ZXMvMjBcbiAgICAgKi9cblxuICAgIC8qKlxuICAgICAqIFdvcmtiZW5jaFxuICAgICAqL1xuICAgIGFwcC5nZXQoJy9jYWxsYmFjaycsIGFzeW5jIChyZXEsIHJlcGx5KSA9PiB7XG4gICAgICAgIGNvbnN0IGhvc3QgPSBgJHtyZXEucHJvdG9jb2x9Oi8vJHtyZXEuaG9zdG5hbWUgfHwgREVGQVVMVF9WU0NPREVfV0VCX0hPU1ROQU1FfToke3BvcnR9YFxuICAgICAgICBjb25zdCBjYlVybCA9IGAke2hvc3R9LyR7cmVxLnVybH0vb3V0L3ZzL2NvZGUvYnJvd3Nlci93b3JrYmVuY2gvY2FsbGJhY2suaHRtbGBcbiAgICAgICAgY29uc3QgeyBib2R5IH0gPSBhd2FpdCByZXF1ZXN0KGNiVXJsLCB7fSlcbiAgICAgICAgYXdhaXQgcmVwbHkuc2VuZChib2R5KVxuICAgIH0pXG5cbiAgICBhcHAuZ2V0KCcvJywgYXN5bmMgKHJlcSwgcmVwbHkpID0+IHtcbiAgICAgICAgY29uc3QgaG9zdG5hbWUgPSByZXEuaG9zdG5hbWUgfHwgREVGQVVMVF9WU0NPREVfV0VCX0hPU1ROQU1FXG4gICAgICAgIGNvbnN0IGhvc3QgPSBgJHtyZXEucHJvdG9jb2x9Oi8vJHtob3N0bmFtZX1gXG4gICAgICAgIGNvbnN0IHdlYkNvbmZpZ3VyYXRpb24gPSBhd2FpdCBnZXRXb3JrYmVuY2hPcHRpb25zKFxuICAgICAgICAgICAgeyBwcm90b2NvbDogcmVxLnByb3RvY29sLCBob3N0OiBob3N0bmFtZSB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIG1vZGlmeSB3aGVuIHN1cHBvcnQgYWRkaXRpb25hbCBleHRlbnNpb25cbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBleHRlbnNpb25QYXRoczogW10sXG4gICAgICAgICAgICAgICAgZXh0ZW5zaW9uSWRzOiBbXSwgLy8gR2FsbGVyeUV4dGVuc2lvbkluZm9bXSB8IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIGV4dGVuc2lvbkRldmVsb3BtZW50UGF0aDogb3B0aW9ucy5leHRlbnNpb25QYXRoLFxuICAgICAgICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGF0aWMnIGFzIGNvbnN0LFxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjogc3RhbmRhbG9uZS5wYXRoLFxuICAgICAgICAgICAgICAgICAgICBxdWFsaXR5OiAob3B0aW9ucy52ZXJzaW9uIHx8IERFRkFVTFRfQ0hBTk5FTCkgYXMgJ3N0YWJsZScgfCAnaW5zaWRlcicsXG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb246IHN0YW5kYWxvbmUudmVyc2lvblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXh0ZW5zaW9uVGVzdHNQYXRoOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZm9sZGVyVXJpOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZm9sZGVyTW91bnRQYXRoOiBvcHRpb25zLndvcmtzcGFjZVBhdGgsXG4gICAgICAgICAgICAgICAgcHJpbnRTZXJ2ZXJMb2c6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgKVxuXG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZ2V0V29ya2JlbmNoKHtcbiAgICAgICAgICAgIGJhc2VVcmw6IGAke2hvc3R9L3N0YXRpYy9idWlsZGAsXG4gICAgICAgICAgICB3ZWJDb25maWd1cmF0aW9uOiBKU09OLnN0cmluZ2lmeSh3ZWJDb25maWd1cmF0aW9uKS5yZXBsYWNlKC9cIi9nLCAnJnF1b3Q7JyksXG4gICAgICAgICAgICBhdXRoU2Vzc2lvbjogJycsXG4gICAgICAgICAgICBidWlsdGluRXh0ZW5zaW9uczogJ1tdJ1xuICAgICAgICB9KVxuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgcmVwbHkuaGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9odG1sJylcbiAgICAgICAgcmV0dXJuIHJlcGx5LnNlbmQodGVtcGxhdGUpXG4gICAgfSlcblxuICAgIGF3YWl0IGFwcC5saXN0ZW4ocG9ydClcbiAgICBsb2cuaW5mbyhgVlNDb2RlIHNlcnZlciBzdGFydGVkIG9uIHBvcnQgJHtwb3J0fWApXG4gICAgcmV0dXJuIHBvcnRcbn1cbiJdfQ==