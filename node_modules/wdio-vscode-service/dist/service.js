import fs from 'node:fs/promises';
import url from 'node:url';
import util from 'node:util';
import path from 'node:path';
import slash from 'slash';
import tmp from 'tmp-promise';
import logger from '@wdio/logger';
import getPort from 'get-port';
import decamelize from 'decamelize';
import { WebSocketServer } from 'ws';
import { SevereServiceError } from 'webdriverio';
import { Workbench } from './pageobjects/index.js';
import { getLocators, getValueSuffix, isVSCodeCapability } from './utils.js';
import { VSCODE_APPLICATION_ARGS, DEFAULT_VSCODE_SETTINGS, DEFAULT_PROXY_OPTIONS, SETTINGS_KEY, VSCODE_CAPABILITY_KEY, DEFAULT_VSCODE_WEB_PORT } from './constants.js';
const log = logger('wdio-vscode-service');
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
export default class VSCodeWorkerService {
    constructor(_, _capabilities) {
        this._capabilities = _capabilities;
        this._messageId = 0;
        this._pendingMessages = new Map();
        this._isWebSession = false;
        this._vscodeOptions = this._capabilities[VSCODE_CAPABILITY_KEY] || {};
        this._proxyOptions = { ...DEFAULT_PROXY_OPTIONS, ...this._vscodeOptions.vscodeProxyOptions };
    }
    _handleIncoming(data) {
        try {
            const message = JSON.parse(data.toString('utf-8'));
            const resolver = this._pendingMessages.get(message.id);
            if (!resolver) {
                log.error(`Couldn't find remote message resolver with id ${message.id}`);
                return;
            }
            resolver(message.error, message.result);
            return;
        }
        catch (err) {
            log.error(`Error parsing remote response: ${err.message}`);
        }
    }
    async beforeSession(option, capabilities) {
        this._isWebSession = capabilities.browserName !== 'vscode';
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * if we run tests for a web extension
         */
        if (this._isWebSession) {
            const serverOptions = capabilities[VSCODE_CAPABILITY_KEY]?.serverOptions;
            option.baseUrl = util.format('http://%s:%s', serverOptions?.hostname || 'localhost', (serverOptions?.port || DEFAULT_VSCODE_WEB_PORT).toString());
            log.info(`Run VSCode as web app on ${option.baseUrl}`);
            return;
        }
        const customArgs = { ...VSCODE_APPLICATION_ARGS };
        const storagePath = await tmp.dir();
        const userSettingsPath = path.join(storagePath.path, 'settings', 'User');
        const userSettings = {
            ...DEFAULT_VSCODE_SETTINGS,
            ...(this._vscodeOptions.userSettings || {})
        };
        if (!this._vscodeOptions.extensionPath) {
            throw new SevereServiceError('No extension path provided');
        }
        if (this._proxyOptions.enable) {
            const port = await getPort({ port: this._proxyOptions.port });
            userSettings[SETTINGS_KEY].port = port;
            log.info(`Start VSCode proxy server on port ${port}`);
            const wss = this._wss = new WebSocketServer({ port });
            this._promisedSocket = new Promise((resolve, reject) => {
                const socketTimeout = setTimeout(() => reject(new Error('Connection timeout exceeded')), this._proxyOptions.connectionTimeout);
                wss.on('connection', (socket) => {
                    log.info('Connected with VSCode workbench');
                    resolve(socket);
                    clearTimeout(socketTimeout);
                    socket.on('message', this._handleIncoming.bind(this));
                });
            });
        }
        customArgs.extensionDevelopmentPath = slash(this._vscodeOptions.extensionPath);
        customArgs.extensionTestsPath = slash(path.join(__dirname, 'proxy', 'cjs', 'entry.js'));
        customArgs.userDataDir = slash(path.join(storagePath.path, 'settings'));
        customArgs.extensionsDir = slash(path.join(storagePath.path, 'extensions'));
        customArgs.vscodeBinaryPath = this._vscodeOptions.binary;
        log.info(`Setting up VSCode directory at ${userSettingsPath}`);
        await fs.mkdir(userSettingsPath, { recursive: true });
        await fs.writeFile(path.join(userSettingsPath, 'settings.json'), JSON.stringify(userSettings), 'utf-8');
        if (this._vscodeOptions.workspacePath) {
            customArgs.folderUri = `file:${slash(this._vscodeOptions.workspacePath)}`;
        }
        if (this._vscodeOptions.filePath) {
            customArgs.fileUri = `file:${slash(this._vscodeOptions.filePath)}`;
        }
        if (this._vscodeOptions.verboseLogging) {
            customArgs.verbose = true;
            customArgs.logExtensionHostCommunication = true;
        }
        const binary = path.join(__dirname, 'chromium', `index.${process.platform === 'win32' ? 'exe' : 'js'}`);
        const args = Object.entries({ ...customArgs, ...this._vscodeOptions.vscodeArgs }).reduce((prev, [key, value]) => [
            ...prev,
            `--${decamelize(key, { separator: '-' })}${getValueSuffix(value)}`
        ], []);
        /**
         * need to rename capability back to Chrome otherwise Chromedriver
         * won't recognise this capability
         */
        capabilities.browserName = 'chrome';
        capabilities['goog:chromeOptions'] = { binary, args, windowTypes: ['webview'] };
        log.info(`Start VSCode: ${binary} ${args.join(' ')}`);
    }
    async before(capabilities, __, browser) {
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * open VSCode web when testing web extensions
         */
        if (this._isWebSession) {
            await browser.url('/');
        }
        this._browser = browser;
        const locators = await getLocators(capabilities.browserVersion || 'insiders');
        const workbenchPO = new Workbench(locators);
        this._browser.addCommand('getWorkbench', () => workbenchPO.wait());
        this._browser.addCommand('executeWorkbench', this._executeVSCode.bind(this));
        this._browser.addCommand('getVSCodeVersion', () => capabilities.browserVersion);
        this._browser.addCommand('isVSCodeWebSession', () => this._isWebSession);
        this._browser.addCommand('getVSCodeChannel', () => (capabilities.browserVersion === 'insiders' ? 'insiders' : 'vscode'));
        await workbenchPO.elem.waitForExist();
        /**
         * VSCode in the browser doesn't allow to have a file directly opened,
         * therefore we need to open it automatically
         */
        if (this._isWebSession && this._vscodeOptions.filePath && this._vscodeOptions.workspacePath) {
            const sections = this._vscodeOptions.filePath.replace(this._vscodeOptions.workspacePath, '')
                .split(path.sep).filter(Boolean);
            const fileExplorer = await browser.$('.explorer-folders-view');
            while (sections.length > 0) {
                const entry = sections.shift();
                await fileExplorer.$(`span=${entry}`).click();
            }
        }
    }
    async after() {
        if (!isVSCodeCapability(this._capabilities)
            || !this._browser
            || !this._capabilities[VSCODE_CAPABILITY_KEY]?.verboseLogging) {
            return;
        }
        const logs = await this._browser.getLogs('browser').then((res) => res, (err) => err);
        if (logs instanceof Error) {
            return;
        }
        for (const l of logs) {
            log.info(`[${(new Date(l.timestamp)).toISOString()}]`
                + ` - ${l.source} - ${l.message}`);
        }
        if (this._wss) {
            this._wss.close();
        }
    }
    async _executeVSCode(fn, ...params) {
        if (!this._promisedSocket || this._isWebSession) {
            const errorMessage = this._isWebSession
                ? 'not support when testing web extensions'
                : 'see "vscodeProxyOptions" option in service docs';
            throw new Error(`VSCode API proxy not enabled, ${errorMessage}`);
        }
        const socket = await this._promisedSocket;
        const proxyFn = typeof fn === 'function'
            ? fn.toString()
            : fn;
        socket.send(JSON.stringify({
            id: this._messageId,
            fn: proxyFn,
            params
        }));
        const returnVal = new Promise((resolve, reject) => {
            const cmdTimeout = setTimeout(() => reject(new Error('Remote command timeout exceeded')), this._proxyOptions.commandTimeout);
            this._pendingMessages.set(this._messageId, (error, result) => {
                clearTimeout(cmdTimeout);
                if (error) {
                    reject(new Error(error));
                    return;
                }
                resolve(result);
            });
        });
        this._messageId += 1;
        return returnVal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFDNUIsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFBO0FBQzVCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUE7QUFDN0IsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxFQUFFLGVBQWUsRUFBYSxNQUFNLElBQUksQ0FBQTtBQUUvQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzVFLE9BQU8sRUFDSCx1QkFBdUIsRUFBRSx1QkFBdUIsRUFBRSxxQkFBcUIsRUFDdkUsWUFBWSxFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUMvRCxNQUFNLGdCQUFnQixDQUFBO0FBTXZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNsRSxNQUFNLENBQUMsT0FBTyxPQUFPLG1CQUFtQjtJQVVwQyxZQUFhLENBQVEsRUFBVSxhQUFpQztRQUFqQyxr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QUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO29CQUN4QixPQUFNO2lCQUNUO2dCQUNELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNuQixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUE7UUFDcEIsT0FBTyxTQUFTLENBQUE7SUFDcEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ25vZGU6ZnMvcHJvbWlzZXMnXG5pbXBvcnQgdXJsIGZyb20gJ25vZGU6dXJsJ1xuaW1wb3J0IHV0aWwgZnJvbSAnbm9kZTp1dGlsJ1xuaW1wb3J0IHBhdGggZnJvbSAnbm9kZTpwYXRoJ1xuaW1wb3J0IHNsYXNoIGZyb20gJ3NsYXNoJ1xuaW1wb3J0IHRtcCBmcm9tICd0bXAtcHJvbWlzZSdcbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IGdldFBvcnQgZnJvbSAnZ2V0LXBvcnQnXG5pbXBvcnQgZGVjYW1lbGl6ZSBmcm9tICdkZWNhbWVsaXplJ1xuaW1wb3J0IHsgV2ViU29ja2V0U2VydmVyLCBXZWJTb2NrZXQgfSBmcm9tICd3cydcbmltcG9ydCB7IFNlcnZpY2VzLCBPcHRpb25zIH0gZnJvbSAnQHdkaW8vdHlwZXMnXG5pbXBvcnQgeyBTZXZlcmVTZXJ2aWNlRXJyb3IgfSBmcm9tICd3ZWJkcml2ZXJpbydcblxuaW1wb3J0IHsgV29ya2JlbmNoIH0gZnJvbSAnLi9wYWdlb2JqZWN0cy9pbmRleC5qcydcbmltcG9ydCB7IGdldExvY2F0b3JzLCBnZXRWYWx1ZVN1ZmZpeCwgaXNWU0NvZGVDYXBhYmlsaXR5IH0gZnJvbSAnLi91dGlscy5qcydcbmltcG9ydCB7XG4gICAgVlNDT0RFX0FQUExJQ0FUSU9OX0FSR1MsIERFRkFVTFRfVlNDT0RFX1NFVFRJTkdTLCBERUZBVUxUX1BST1hZX09QVElPTlMsXG4gICAgU0VUVElOR1NfS0VZLCBWU0NPREVfQ0FQQUJJTElUWV9LRVksIERFRkFVTFRfVlNDT0RFX1dFQl9QT1JUXG59IGZyb20gJy4vY29uc3RhbnRzLmpzJ1xuaW1wb3J0IHR5cGUge1xuICAgIFZTQ29kZUNhcGFiaWxpdGllcywgV0RJT0xvZ3MsIEFyZ3NQYXJhbXMsIFJlbW90ZUNvbW1hbmQsIFJlbW90ZVJlc3BvbnNlLFxuICAgIFBlbmRpbmdNZXNzYWdlUmVzb2x2ZXIsIFZTQ29kZVByb3h5T3B0aW9ucywgVlNDb2RlT3B0aW9uc1xufSBmcm9tICcuL3R5cGVzJ1xuXG5jb25zdCBsb2cgPSBsb2dnZXIoJ3dkaW8tdnNjb2RlLXNlcnZpY2UnKVxuY29uc3QgX19kaXJuYW1lID0gdXJsLmZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLicsIGltcG9ydC5tZXRhLnVybCkpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWU0NvZGVXb3JrZXJTZXJ2aWNlIGltcGxlbWVudHMgU2VydmljZXMuU2VydmljZUluc3RhbmNlIHtcbiAgICBwcml2YXRlIF9icm93c2VyPzogV2ViZHJpdmVySU8uQnJvd3NlclxuICAgIHByaXZhdGUgX3dzcz86IFdlYlNvY2tldFNlcnZlclxuICAgIHByaXZhdGUgX21lc3NhZ2VJZCA9IDBcbiAgICBwcml2YXRlIF9wZW5kaW5nTWVzc2FnZXMgPSBuZXcgTWFwPG51bWJlciwgUGVuZGluZ01lc3NhZ2VSZXNvbHZlcj4oKVxuICAgIHByaXZhdGUgX3Byb21pc2VkU29ja2V0PzogUHJvbWlzZTxXZWJTb2NrZXQ+XG4gICAgcHJpdmF0ZSBfcHJveHlPcHRpb25zOiBWU0NvZGVQcm94eU9wdGlvbnNcbiAgICBwcml2YXRlIF92c2NvZGVPcHRpb25zOiBWU0NvZGVPcHRpb25zXG4gICAgcHJpdmF0ZSBfaXNXZWJTZXNzaW9uID0gZmFsc2VcblxuICAgIGNvbnN0cnVjdG9yIChfOiBuZXZlciwgcHJpdmF0ZSBfY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdGhpcy5fdnNjb2RlT3B0aW9ucyA9IHRoaXMuX2NhcGFiaWxpdGllc1tWU0NPREVfQ0FQQUJJTElUWV9LRVldIHx8IDxWU0NvZGVPcHRpb25zPnt9XG4gICAgICAgIHRoaXMuX3Byb3h5T3B0aW9ucyA9IHsgLi4uREVGQVVMVF9QUk9YWV9PUFRJT05TLCAuLi50aGlzLl92c2NvZGVPcHRpb25zLnZzY29kZVByb3h5T3B0aW9ucyB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlSW5jb21pbmcgKGRhdGE6IEJ1ZmZlcikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygndXRmLTgnKSkgYXMgUmVtb3RlUmVzcG9uc2VcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpcy5fcGVuZGluZ01lc3NhZ2VzLmdldChtZXNzYWdlLmlkKVxuXG4gICAgICAgICAgICBpZiAoIXJlc29sdmVyKSB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKGBDb3VsZG4ndCBmaW5kIHJlbW90ZSBtZXNzYWdlIHJlc29sdmVyIHdpdGggaWQgJHttZXNzYWdlLmlkfWApXG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmVyKG1lc3NhZ2UuZXJyb3IsIG1lc3NhZ2UucmVzdWx0KVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoYEVycm9yIHBhcnNpbmcgcmVtb3RlIHJlc3BvbnNlOiAke2Vyci5tZXNzYWdlfWApXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBiZWZvcmVTZXNzaW9uIChvcHRpb246IE9wdGlvbnMuVGVzdHJ1bm5lciwgY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdGhpcy5faXNXZWJTZXNzaW9uID0gY2FwYWJpbGl0aWVzLmJyb3dzZXJOYW1lICE9PSAndnNjb2RlJ1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBvbmx5IHJ1biBzZXR1cCBmb3IgVlNDb2RlIGNhcGFiaWxpdGllc1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFpc1ZTQ29kZUNhcGFiaWxpdHkoY2FwYWJpbGl0aWVzKSkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogaWYgd2UgcnVuIHRlc3RzIGZvciBhIHdlYiBleHRlbnNpb25cbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc1dlYlNlc3Npb24pIHtcbiAgICAgICAgICAgIGNvbnN0IHNlcnZlck9wdGlvbnMgPSBjYXBhYmlsaXRpZXNbVlNDT0RFX0NBUEFCSUxJVFlfS0VZXT8uc2VydmVyT3B0aW9uc1xuICAgICAgICAgICAgb3B0aW9uLmJhc2VVcmwgPSB1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICAgICAnaHR0cDovLyVzOiVzJyxcbiAgICAgICAgICAgICAgICBzZXJ2ZXJPcHRpb25zPy5ob3N0bmFtZSB8fCAnbG9jYWxob3N0JyxcbiAgICAgICAgICAgICAgICAoc2VydmVyT3B0aW9ucz8ucG9ydCB8fCBERUZBVUxUX1ZTQ09ERV9XRUJfUE9SVCBhcyBudW1iZXIpLnRvU3RyaW5nKClcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGxvZy5pbmZvKGBSdW4gVlNDb2RlIGFzIHdlYiBhcHAgb24gJHtvcHRpb24uYmFzZVVybH1gKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjdXN0b21BcmdzOiBBcmdzUGFyYW1zID0geyAuLi5WU0NPREVfQVBQTElDQVRJT05fQVJHUyB9XG4gICAgICAgIGNvbnN0IHN0b3JhZ2VQYXRoID0gYXdhaXQgdG1wLmRpcigpXG4gICAgICAgIGNvbnN0IHVzZXJTZXR0aW5nc1BhdGggPSBwYXRoLmpvaW4oc3RvcmFnZVBhdGgucGF0aCwgJ3NldHRpbmdzJywgJ1VzZXInKVxuICAgICAgICBjb25zdCB1c2VyU2V0dGluZ3M6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XG4gICAgICAgICAgICAuLi5ERUZBVUxUX1ZTQ09ERV9TRVRUSU5HUyxcbiAgICAgICAgICAgIC4uLih0aGlzLl92c2NvZGVPcHRpb25zLnVzZXJTZXR0aW5ncyB8fCB7fSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fdnNjb2RlT3B0aW9ucy5leHRlbnNpb25QYXRoKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgU2V2ZXJlU2VydmljZUVycm9yKCdObyBleHRlbnNpb24gcGF0aCBwcm92aWRlZCcpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fcHJveHlPcHRpb25zLmVuYWJsZSkge1xuICAgICAgICAgICAgY29uc3QgcG9ydCA9IGF3YWl0IGdldFBvcnQoeyBwb3J0OiB0aGlzLl9wcm94eU9wdGlvbnMucG9ydCB9KVxuICAgICAgICAgICAgdXNlclNldHRpbmdzW1NFVFRJTkdTX0tFWV0ucG9ydCA9IHBvcnRcbiAgICAgICAgICAgIGxvZy5pbmZvKGBTdGFydCBWU0NvZGUgcHJveHkgc2VydmVyIG9uIHBvcnQgJHtwb3J0fWApXG4gICAgICAgICAgICBjb25zdCB3c3MgPSB0aGlzLl93c3MgPSBuZXcgV2ViU29ja2V0U2VydmVyKHsgcG9ydCB9KVxuICAgICAgICAgICAgdGhpcy5fcHJvbWlzZWRTb2NrZXQgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc29ja2V0VGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gdGltZW91dCBleGNlZWRlZCcpKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJveHlPcHRpb25zLmNvbm5lY3Rpb25UaW1lb3V0XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIHdzcy5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Nvbm5lY3RlZCB3aXRoIFZTQ29kZSB3b3JrYmVuY2gnKVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNvY2tldClcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNvY2tldFRpbWVvdXQpXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIHRoaXMuX2hhbmRsZUluY29taW5nLmJpbmQodGhpcykpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvbkRldmVsb3BtZW50UGF0aCA9IHNsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMuZXh0ZW5zaW9uUGF0aClcbiAgICAgICAgY3VzdG9tQXJncy5leHRlbnNpb25UZXN0c1BhdGggPSBzbGFzaChwYXRoLmpvaW4oX19kaXJuYW1lLCAncHJveHknLCAnY2pzJywgJ2VudHJ5LmpzJykpXG4gICAgICAgIGN1c3RvbUFyZ3MudXNlckRhdGFEaXIgPSBzbGFzaChwYXRoLmpvaW4oc3RvcmFnZVBhdGgucGF0aCwgJ3NldHRpbmdzJykpXG4gICAgICAgIGN1c3RvbUFyZ3MuZXh0ZW5zaW9uc0RpciA9IHNsYXNoKHBhdGguam9pbihzdG9yYWdlUGF0aC5wYXRoLCAnZXh0ZW5zaW9ucycpKVxuICAgICAgICBjdXN0b21BcmdzLnZzY29kZUJpbmFyeVBhdGggPSB0aGlzLl92c2NvZGVPcHRpb25zLmJpbmFyeSBhcyBzdHJpbmdcblxuICAgICAgICBsb2cuaW5mbyhgU2V0dGluZyB1cCBWU0NvZGUgZGlyZWN0b3J5IGF0ICR7dXNlclNldHRpbmdzUGF0aH1gKVxuICAgICAgICBhd2FpdCBmcy5ta2Rpcih1c2VyU2V0dGluZ3NQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KVxuICAgICAgICBhd2FpdCBmcy53cml0ZUZpbGUoXG4gICAgICAgICAgICBwYXRoLmpvaW4odXNlclNldHRpbmdzUGF0aCwgJ3NldHRpbmdzLmpzb24nKSxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHVzZXJTZXR0aW5ncyksXG4gICAgICAgICAgICAndXRmLTgnXG4gICAgICAgIClcblxuICAgICAgICBpZiAodGhpcy5fdnNjb2RlT3B0aW9ucy53b3Jrc3BhY2VQYXRoKSB7XG4gICAgICAgICAgICBjdXN0b21BcmdzLmZvbGRlclVyaSA9IGBmaWxlOiR7c2xhc2godGhpcy5fdnNjb2RlT3B0aW9ucy53b3Jrc3BhY2VQYXRoKX1gXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aCkge1xuICAgICAgICAgICAgY3VzdG9tQXJncy5maWxlVXJpID0gYGZpbGU6JHtzbGFzaCh0aGlzLl92c2NvZGVPcHRpb25zLmZpbGVQYXRoKX1gXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fdnNjb2RlT3B0aW9ucy52ZXJib3NlTG9nZ2luZykge1xuICAgICAgICAgICAgY3VzdG9tQXJncy52ZXJib3NlID0gdHJ1ZVxuICAgICAgICAgICAgY3VzdG9tQXJncy5sb2dFeHRlbnNpb25Ib3N0Q29tbXVuaWNhdGlvbiA9IHRydWVcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJpbmFyeSA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdjaHJvbWl1bScsIGBpbmRleC4ke3Byb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicgPyAnZXhlJyA6ICdqcyd9YClcbiAgICAgICAgY29uc3QgYXJncyA9IE9iamVjdC5lbnRyaWVzKHsgLi4uY3VzdG9tQXJncywgLi4udGhpcy5fdnNjb2RlT3B0aW9ucy52c2NvZGVBcmdzIH0pLnJlZHVjZShcbiAgICAgICAgICAgIChwcmV2LCBba2V5LCB2YWx1ZV0pID0+IFtcbiAgICAgICAgICAgICAgICAuLi5wcmV2LFxuICAgICAgICAgICAgICAgIGAtLSR7ZGVjYW1lbGl6ZShrZXksIHsgc2VwYXJhdG9yOiAnLScgfSl9JHtnZXRWYWx1ZVN1ZmZpeCh2YWx1ZSl9YFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFtdIGFzIHN0cmluZ1tdXG4gICAgICAgIClcblxuICAgICAgICAvKipcbiAgICAgICAgICogbmVlZCB0byByZW5hbWUgY2FwYWJpbGl0eSBiYWNrIHRvIENocm9tZSBvdGhlcndpc2UgQ2hyb21lZHJpdmVyXG4gICAgICAgICAqIHdvbid0IHJlY29nbmlzZSB0aGlzIGNhcGFiaWxpdHlcbiAgICAgICAgICovXG4gICAgICAgIGNhcGFiaWxpdGllcy5icm93c2VyTmFtZSA9ICdjaHJvbWUnXG4gICAgICAgIGNhcGFiaWxpdGllc1snZ29vZzpjaHJvbWVPcHRpb25zJ10gPSB7IGJpbmFyeSwgYXJncywgd2luZG93VHlwZXM6IFsnd2VidmlldyddIH1cbiAgICAgICAgbG9nLmluZm8oYFN0YXJ0IFZTQ29kZTogJHtiaW5hcnl9ICR7YXJncy5qb2luKCcgJyl9YClcbiAgICB9XG5cbiAgICBhc3luYyBiZWZvcmUgKGNhcGFiaWxpdGllczogVlNDb2RlQ2FwYWJpbGl0aWVzLCBfXzogbmV2ZXIsIGJyb3dzZXI6IFdlYmRyaXZlcklPLkJyb3dzZXIpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9ubHkgcnVuIHNldHVwIGZvciBWU0NvZGUgY2FwYWJpbGl0aWVzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWlzVlNDb2RlQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBvcGVuIFZTQ29kZSB3ZWIgd2hlbiB0ZXN0aW5nIHdlYiBleHRlbnNpb25zXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5faXNXZWJTZXNzaW9uKSB7XG4gICAgICAgICAgICBhd2FpdCBicm93c2VyLnVybCgnLycpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9icm93c2VyID0gYnJvd3NlclxuICAgICAgICBjb25zdCBsb2NhdG9ycyA9IGF3YWl0IGdldExvY2F0b3JzKGNhcGFiaWxpdGllcy5icm93c2VyVmVyc2lvbiB8fCAnaW5zaWRlcnMnKVxuICAgICAgICBjb25zdCB3b3JrYmVuY2hQTyA9IG5ldyBXb3JrYmVuY2gobG9jYXRvcnMpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZ2V0V29ya2JlbmNoJywgKCkgPT4gd29ya2JlbmNoUE8ud2FpdCgpKVxuICAgICAgICB0aGlzLl9icm93c2VyLmFkZENvbW1hbmQoJ2V4ZWN1dGVXb3JrYmVuY2gnLCB0aGlzLl9leGVjdXRlVlNDb2RlLmJpbmQodGhpcykpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZ2V0VlNDb2RlVmVyc2lvbicsICgpID0+IGNhcGFiaWxpdGllcy5icm93c2VyVmVyc2lvbilcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdpc1ZTQ29kZVdlYlNlc3Npb24nLCAoKSA9PiB0aGlzLl9pc1dlYlNlc3Npb24pXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZ2V0VlNDb2RlQ2hhbm5lbCcsICgpID0+IChcbiAgICAgICAgICAgIGNhcGFiaWxpdGllcy5icm93c2VyVmVyc2lvbiA9PT0gJ2luc2lkZXJzJyA/ICdpbnNpZGVycycgOiAndnNjb2RlJ1xuICAgICAgICApKVxuICAgICAgICBhd2FpdCB3b3JrYmVuY2hQTy5lbGVtLndhaXRGb3JFeGlzdCgpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFZTQ29kZSBpbiB0aGUgYnJvd3NlciBkb2Vzbid0IGFsbG93IHRvIGhhdmUgYSBmaWxlIGRpcmVjdGx5IG9wZW5lZCxcbiAgICAgICAgICogdGhlcmVmb3JlIHdlIG5lZWQgdG8gb3BlbiBpdCBhdXRvbWF0aWNhbGx5XG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5faXNXZWJTZXNzaW9uICYmIHRoaXMuX3ZzY29kZU9wdGlvbnMuZmlsZVBhdGggJiYgdGhpcy5fdnNjb2RlT3B0aW9ucy53b3Jrc3BhY2VQYXRoKSB7XG4gICAgICAgICAgICBjb25zdCBzZWN0aW9ucyA9IHRoaXMuX3ZzY29kZU9wdGlvbnMuZmlsZVBhdGgucmVwbGFjZSh0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgsICcnKVxuICAgICAgICAgICAgICAgIC5zcGxpdChwYXRoLnNlcCkuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAgICAgICBjb25zdCBmaWxlRXhwbG9yZXIgPSBhd2FpdCBicm93c2VyLiQoJy5leHBsb3Jlci1mb2xkZXJzLXZpZXcnKVxuICAgICAgICAgICAgd2hpbGUgKHNlY3Rpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IHNlY3Rpb25zLnNoaWZ0KClcbiAgICAgICAgICAgICAgICBhd2FpdCBmaWxlRXhwbG9yZXIuJChgc3Bhbj0ke2VudHJ5fWApLmNsaWNrKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGFmdGVyICgpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgIWlzVlNDb2RlQ2FwYWJpbGl0eSh0aGlzLl9jYXBhYmlsaXRpZXMpXG4gICAgICAgICAgICB8fCAhdGhpcy5fYnJvd3NlclxuICAgICAgICAgICAgfHwgIXRoaXMuX2NhcGFiaWxpdGllc1tWU0NPREVfQ0FQQUJJTElUWV9LRVldPy52ZXJib3NlTG9nZ2luZ1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbG9ncyA9IGF3YWl0IHRoaXMuX2Jyb3dzZXIuZ2V0TG9ncygnYnJvd3NlcicpLnRoZW4oXG4gICAgICAgICAgICAocmVzKSA9PiByZXMgYXMgV0RJT0xvZ3NbXSxcbiAgICAgICAgICAgIChlcnIpID0+IGVyciBhcyBFcnJvclxuICAgICAgICApXG5cbiAgICAgICAgaWYgKGxvZ3MgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IGwgb2YgbG9ncykge1xuICAgICAgICAgICAgbG9nLmluZm8oXG4gICAgICAgICAgICAgICAgYFskeyhuZXcgRGF0ZShsLnRpbWVzdGFtcCkpLnRvSVNPU3RyaW5nKCl9XWBcbiAgICAgICAgICAgICAgICArIGAgLSAke2wuc291cmNlfSAtICR7bC5tZXNzYWdlfWBcbiAgICAgICAgICAgIClcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl93c3MpIHtcbiAgICAgICAgICAgIHRoaXMuX3dzcy5jbG9zZSgpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9leGVjdXRlVlNDb2RlIChmbjogRnVuY3Rpb24gfCBzdHJpbmcsIC4uLnBhcmFtczogYW55W10pIHtcbiAgICAgICAgaWYgKCF0aGlzLl9wcm9taXNlZFNvY2tldCB8fCB0aGlzLl9pc1dlYlNlc3Npb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IHRoaXMuX2lzV2ViU2Vzc2lvblxuICAgICAgICAgICAgICAgID8gJ25vdCBzdXBwb3J0IHdoZW4gdGVzdGluZyB3ZWIgZXh0ZW5zaW9ucydcbiAgICAgICAgICAgICAgICA6ICdzZWUgXCJ2c2NvZGVQcm94eU9wdGlvbnNcIiBvcHRpb24gaW4gc2VydmljZSBkb2NzJ1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBWU0NvZGUgQVBJIHByb3h5IG5vdCBlbmFibGVkLCAke2Vycm9yTWVzc2FnZX1gKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc29ja2V0ID0gYXdhaXQgdGhpcy5fcHJvbWlzZWRTb2NrZXRcblxuICAgICAgICBjb25zdCBwcm94eUZuID0gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICA/IGZuLnRvU3RyaW5nKClcbiAgICAgICAgICAgIDogZm5cblxuICAgICAgICBzb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeSg8UmVtb3RlQ29tbWFuZD57XG4gICAgICAgICAgICBpZDogdGhpcy5fbWVzc2FnZUlkLFxuICAgICAgICAgICAgZm46IHByb3h5Rm4sXG4gICAgICAgICAgICBwYXJhbXNcbiAgICAgICAgfSkpXG5cbiAgICAgICAgY29uc3QgcmV0dXJuVmFsID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY21kVGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgKCkgPT4gcmVqZWN0KG5ldyBFcnJvcignUmVtb3RlIGNvbW1hbmQgdGltZW91dCBleGNlZWRlZCcpKSxcbiAgICAgICAgICAgICAgICB0aGlzLl9wcm94eU9wdGlvbnMuY29tbWFuZFRpbWVvdXRcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdNZXNzYWdlcy5zZXQodGhpcy5fbWVzc2FnZUlkLCAoZXJyb3I6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoY21kVGltZW91dClcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihlcnJvcikpXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuX21lc3NhZ2VJZCArPSAxXG4gICAgICAgIHJldHVybiByZXR1cm5WYWxcbiAgICB9XG59XG5cbmludGVyZmFjZSBWU0NvZGVDb21tYW5kcyB7XG4gICAgZ2V0V29ya2JlbmNoOiAoKSA9PiBQcm9taXNlPFdvcmtiZW5jaD5cbiAgICAvLyBUb2RvKENocmlzdGlhbik6IHByb3Blcmx5IHR5cGUgVlNDb2RlIG9iamVjdCBoZXJlXG4gICAgZXhlY3V0ZVdvcmtiZW5jaDogPFQ+KGZuOiAodnNjb2RlOiBhbnksIC4uLnBhcmFtczogYW55W10pID0+IFQsIC4uLnBhcmFtczogYW55W10pID0+IFByb21pc2U8VD5cbiAgICBnZXRWU0NvZGVWZXJzaW9uOiAoKSA9PiBQcm9taXNlPHN0cmluZz5cbiAgICBnZXRWU0NvZGVDaGFubmVsOiAoKSA9PiBQcm9taXNlPHN0cmluZz5cbiAgICBpc1ZTQ29kZVdlYlNlc3Npb246ICgpID0+IFByb21pc2U8Ym9vbGVhbj5cbn1cblxuZGVjbGFyZSBnbG9iYWwge1xuICAgIG5hbWVzcGFjZSBXZWJkcml2ZXJJTyB7XG4gICAgICAgIGludGVyZmFjZSBCcm93c2VyIGV4dGVuZHMgVlNDb2RlQ29tbWFuZHMge31cbiAgICB9XG5cbiAgICBuYW1lc3BhY2UgV2ViZHJpdmVySU9Bc3luYyB7XG4gICAgICAgIGludGVyZmFjZSBCcm93c2VyIGV4dGVuZHMgVlNDb2RlQ29tbWFuZHMge31cbiAgICAgICAgaW50ZXJmYWNlIE11bHRpUmVtb3RlQnJvd3NlciBleHRlbmRzIFZTQ29kZUNvbW1hbmRzIHsgfVxuICAgIH1cbn1cbiJdfQ==